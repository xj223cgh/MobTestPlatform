/* empty css                  *//* empty css                   */import{E as e}from"./el-pagination-aa6134da.js";import{E as a}from"./el-tag-418c1d1c.js";import{a as l,E as t}from"./el-select-b829cea3.js";import"./el-scrollbar-0528a0c4.js";import{E as o,a as r}from"./el-input-89ea148f.js";import{E as s,a as n}from"./el-table-column-5340bcc8.js";import"./el-checkbox-14904d7f.js";import"./el-tooltip-4ed993c7.js";import{E as i}from"./el-date-picker-panel-44b3f9b1.js";import{d as u}from"./dayjs.min-fd58e32d.js";import{r as d,b as c,o as g,c as m,d as v,e as p,f,w as y,a5 as h,J as _,n as w,l as b,h as A,aB as j,j as Y,a7 as S,ap as z,aD as x,L as M,ao as C,E as V}from"./index-cd351671.js";import{c as k,g as J,d as N}from"./project-79976e72.js";import{g as O}from"./user-d427ae24.js";import{_ as D}from"./_plugin-vue_export-helper-1b428a4d.js";import{v as E}from"./directive-1c779a20.js";import"./strings-b003b1cc.js";import"./castArray-824cd328.js";import"./omit-7b0b3aa9.js";import"./raf-907dd12a.js";import"./index-6e95e63b.js";const q=(e,a="YYYY-MM-DD HH:mm:ss")=>e?u(e).format(a):"-",P={class:"requirement-management"},I={class:"page-header"},U={class:"header-actions"},$={class:"search-section"},B={class:"table-section"},L={class:"wrap-text"},T={class:"operation-buttons"},H={class:"fixed-pagination"},F=D({__name:"RequirementManagement",setup(D){const F=d(!1),K=u(),R=d([K.subtract(2,"month").format("YYYY-MM"),K.add(2,"month").format("YYYY-MM")]),Z=d([]),G=d([]),Q=d([]),W=d([]),X=c({}),ee=d([]),ae=d([]),le=d([]),te=d([]),oe=d([]),re=d([]),se=c({currentPage:1,pageSize:10,total:0}),ne=async()=>{F.value=!0;try{const e=await k();if(200===e.code){let a=e.data.items||[];a.sort((e,a)=>{const l=new Date(e.updated_at||e.created_at||0);return new Date(a.updated_at||a.created_at||0)-l}),Z.value&&Z.value.length>0&&(a=a.filter(e=>Z.value.includes(e.project_id))),G.value&&G.value.length>0&&(a=a.filter(e=>G.value.includes(e.iteration_id))),Q.value&&Q.value.length>0&&(a=a.filter(e=>Q.value.includes(e.created_by))),W.value&&W.value.length>0&&(a=a.filter(e=>W.value.includes(e.assigned_to))),se.total=a.length||0;const l=(se.currentPage-1)*se.pageSize,t=l+se.pageSize;re.value=a.slice(l,t)}else w.error("获取需求列表失败")}catch(e){console.error("获取需求列表失败:",e),w.error("获取需求列表失败")}finally{F.value=!1}},ie=e=>({new:"新建",in_progress:"进行中",completed:"已完成",cancelled:"已取消"}[e]||e),ue=e=>({high:"高",medium:"中",low:"低"}[e]||e),de=e=>({test:"测试环境",staging:"预发环境",production:"正式环境"}[e]||e),ce=()=>{const e=u();R.value=[e.subtract(2,"month").format("YYYY-MM"),e.add(2,"month").format("YYYY-MM")],Z.value=[],G.value=[],Q.value=[],W.value=[],se.currentPage=1,fe(),ne()},ge=async()=>{var e,a;try{const t=((null==(e=(await J({page:1,size:1e3})).data)?void 0:e.items)||[]).filter(e=>{var a;if(!R.value||2!==R.value.length)return!0;const l=null==(a=e.created_at)?void 0:a.substring(0,7);if(!l)return!0;const[t,o]=R.value;return l>=t&&l<=o});if(ee.value=t,Z.value&&Z.value.length>0){const e=[];for(const t of Z.value)try{const l=(null==(a=(await N(t)).data)?void 0:a.items)||[];e.push(...l)}catch(l){console.error(`获取项目${t}的迭代失败:`,l)}ae.value=e}console.log("时间范围筛选已更新，只影响项目和迭代下拉列表")}catch(l){console.error("更新项目选项失败:",l),w.error("更新项目选项失败")}},me=async()=>{var e;try{if(Z.value&&0!==Z.value.length){const l=[];for(const t of Z.value)try{const a=(null==(e=(await N(t)).data)?void 0:e.items)||[];l.push(...a)}catch(a){console.error(`获取项目${t}的迭代失败:`,a)}if(ae.value=l,G.value&&G.value.length>0){const e=l.map(e=>e.id),a=G.value.filter(a=>e.includes(a));G.value=a}}else ae.value=[],G.value=[];await pe(),ne()}catch(a){console.error("更新迭代选项失败:",a),w.error("更新迭代选项失败")}},ve=async()=>{try{await pe(),ne()}catch(e){console.error("更新用户选项失败:",e),w.error("更新用户选项失败")}},pe=async()=>{var e;console.log("开始更新用户选项");let a=[];try{console.log("开始调用 getUserList API");const e=await O({page:1,size:1e3});console.log("获取用户列表响应:",JSON.stringify(e,null,2));let l=[];e?Array.isArray(e)?(console.log("响应直接是数组"),l=e):e.data?(console.log("响应包含 data 字段"),Array.isArray(e.data)?(console.log("data 直接是数组"),l=e.data):e.data.users&&Array.isArray(e.data.users)?(console.log("data.users 是数组"),l=e.data.users):e.data.items&&Array.isArray(e.data.items)?(console.log("data.items 是数组"),l=e.data.items):e.data.list&&Array.isArray(e.data.list)?(console.log("data.list 是数组"),l=e.data.list):e.data.records&&Array.isArray(e.data.records)?(console.log("data.records 是数组"),l=e.data.records):(console.log("data 不是数组，也没有 users/items/list/records 字段"),console.log("data 的类型:",typeof e.data),console.log("data 的内容:",JSON.stringify(e.data,null,2)))):e.users&&Array.isArray(e.users)?(console.log("响应直接包含 users 数组"),l=e.users):(console.log("响应不包含 data 字段，也不直接包含 users 字段"),console.log("响应的类型:",typeof e),console.log("响应的内容:",JSON.stringify(e,null,2))):console.log("响应为空"),a=Array.isArray(l)?l:[],console.log("处理后的用户列表:",JSON.stringify(a,null,2)),console.log("用户列表长度:",a.length)}catch(l){console.error("获取用户列表失败:",l),w.error("获取用户列表失败"),a=[]}if(le.value=a,te.value=a,oe.value=a,console.log("设置用户选项:",JSON.stringify(le.value,null,2)),console.log("用户选项长度:",le.value.length),console.log("设置创建者选项:",JSON.stringify(te.value,null,2)),console.log("创建者选项长度:",te.value.length),console.log("设置负责人选项:",JSON.stringify(oe.value,null,2)),console.log("负责人选项长度:",oe.value.length),0!==a.length){if(Z.value&&Z.value.length>0||G.value&&G.value.length>0){console.log("有选中的项目或迭代，开始过滤用户");try{const l=await k();if(200===l.code){const t=(null==(e=l.data)?void 0:e.items)||[];console.log("获取到的需求列表:",t);let o=t;Z.value&&Z.value.length>0&&(o=o.filter(e=>Z.value.includes(e.project_id)),console.log("按项目筛选后的需求:",o)),G.value&&G.value.length>0&&(o=o.filter(e=>G.value.includes(e.iteration_id)),console.log("按迭代筛选后的需求:",o));const r=new Set;o.forEach(e=>{e.created_by&&r.add(e.created_by)}),console.log("提取到的创建者ID:",r);const s=new Set;if(o.forEach(e=>{e.assigned_to&&s.add(e.assigned_to)}),console.log("提取到的负责人ID:",s),r.size>0){const e=a.filter(e=>r.has(e.id));console.log("筛选后的创建者:",e),te.value=e}if(s.size>0){const e=a.filter(e=>s.has(e.id));console.log("筛选后的负责人:",e),oe.value=e}}}catch(l){console.error("根据项目/迭代筛选用户失败:",l)}}}else console.log("没有用户数据，直接返回")},fe=async()=>{var e,a;try{const t=((null==(e=(await J({page:1,size:1e3})).data)?void 0:e.items)||[]).filter(e=>{var a;if(!R.value||2!==R.value.length)return!0;const l=null==(a=e.created_at)?void 0:a.substring(0,7);if(!l)return!0;const[t,o]=R.value;return l>=t&&l<=o});ee.value=t;let o=t;Z.value&&Z.value.length>0&&(o=t.filter(e=>Z.value.includes(e.id)));const r=[];for(const e of o)try{const l=(null==(a=(await N(e.id)).data)?void 0:a.items)||[];r.push(...l)}catch(l){console.error(`获取项目${e.project_name}的迭代失败:`,l)}ae.value=r,await pe()}catch(l){console.error("获取选项数据失败:",l),w.error("获取选项数据失败");try{const e=await O({page:1,size:1e3});console.log("错误情况下获取用户列表响应:",JSON.stringify(e,null,2));let a=[];e?Array.isArray(e)?(console.log("响应直接是数组"),a=e):e.data?(console.log("响应包含 data 字段"),Array.isArray(e.data)?(console.log("data 直接是数组"),a=e.data):e.data.users&&Array.isArray(e.data.users)?(console.log("data.users 是数组"),a=e.data.users):e.data.items&&Array.isArray(e.data.items)?(console.log("data.items 是数组"),a=e.data.items):e.data.list&&Array.isArray(e.data.list)?(console.log("data.list 是数组"),a=e.data.list):e.data.records&&Array.isArray(e.data.records)?(console.log("data.records 是数组"),a=e.data.records):(console.log("data 不是数组，也没有 users/items/list/records 字段"),console.log("data 的类型:",typeof e.data),console.log("data 的内容:",JSON.stringify(e.data,null,2)))):e.users&&Array.isArray(e.users)?(console.log("响应直接包含 users 数组"),a=e.users):(console.log("响应不包含 data 字段，也不直接包含 users 字段"),console.log("响应的类型:",typeof e),console.log("响应的内容:",JSON.stringify(e,null,2))):console.log("响应为空");const l=Array.isArray(a)?a:[];le.value=l,te.value=l,oe.value=l,console.log("错误情况下设置的用户选项:",le.value),console.log("错误情况下设置的用户选项长度:",le.value.length),console.log("错误情况下设置的创建者选项:",te.value),console.log("错误情况下设置的创建者选项长度:",te.value.length),console.log("错误情况下设置的负责人选项:",oe.value),console.log("错误情况下设置的负责人选项长度:",oe.value.length)}catch(t){console.error("获取用户列表失败:",t),le.value=[],te.value=[],oe.value=[]}}},ye=e=>{se.pageSize=e,se.currentPage=1,ne()},he=e=>{se.currentPage=e,ne()},_e=()=>{w.info("创建需求功能待实现")};return g(async()=>{await fe(),ne()}),(u,d)=>{const c=V,g=b,k=i,J=r,N=l,O=t,D=o,K=n,le=a,pe=s,fe=e,we=E;return m(),v("div",P,[p("div",I,[d[6]||(d[6]=p("div",{class:"header-content"},[p("h1",null,"需求管理"),p("p",{class:"description"},"管理系统版本需求信息")],-1)),p("div",U,[f(g,{type:"primary",onClick:_e,loading:F.value},{default:y(()=>[f(c,null,{default:y(()=>[f(A(j))]),_:1}),d[5]||(d[5]=Y(" 创建需求 ",-1))]),_:1},8,["loading"])])]),p("div",$,[f(D,{model:X,inline:""},{default:y(()=>[f(J,{label:"时间"},{default:y(()=>[f(k,{modelValue:R.value,"onUpdate:modelValue":d[0]||(d[0]=e=>R.value=e),type:"monthrange","range-separator":"至","start-placeholder":"开始年月","end-placeholder":"结束年月",format:"YYYY-MM","value-format":"YYYY-MM",onChange:ge,style:{width:"220px"}},null,8,["modelValue"])]),_:1}),f(J,{label:"所属项目"},{default:y(()=>[f(O,{modelValue:Z.value,"onUpdate:modelValue":d[1]||(d[1]=e=>Z.value=e),placeholder:"请选择所属项目",multiple:"",clearable:"",onChange:me,style:{width:"180px"}},{default:y(()=>[(m(!0),v(S,null,z(ee.value,e=>(m(),_(N,{key:e.id,label:e.project_name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),f(J,{label:"所属迭代"},{default:y(()=>[f(O,{modelValue:G.value,"onUpdate:modelValue":d[2]||(d[2]=e=>G.value=e),placeholder:"请选择所属迭代",multiple:"",clearable:"",onChange:ve,disabled:!Z.value||0===Z.value.length,style:{width:"180px"}},{default:y(()=>[(m(!0),v(S,null,z(ae.value,e=>(m(),_(N,{key:e.id,label:e.iteration_name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),f(J,{label:"创建者"},{default:y(()=>[f(O,{modelValue:Q.value,"onUpdate:modelValue":d[3]||(d[3]=e=>Q.value=e),placeholder:"请选择创建者",multiple:"",clearable:"",onChange:ne,filterable:"","allow-create":"","default-first-option":"",style:{width:"180px"}},{default:y(()=>[(m(!0),v(S,null,z(te.value,e=>(m(),_(N,{key:e.id,label:e.real_name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),f(J,{label:"负责人"},{default:y(()=>[f(O,{modelValue:W.value,"onUpdate:modelValue":d[4]||(d[4]=e=>W.value=e),placeholder:"请选择负责人",multiple:"",clearable:"",onChange:ne,filterable:"","allow-create":"","default-first-option":"",style:{width:"180px"}},{default:y(()=>[(m(!0),v(S,null,z(oe.value,e=>(m(),_(N,{key:e.id,label:e.real_name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),f(J,null,{default:y(()=>[f(g,{onClick:ce,loading:F.value},{default:y(()=>[f(c,null,{default:y(()=>[f(A(x))]),_:1}),d[7]||(d[7]=Y(" 重置 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),p("div",B,[h((m(),_(pe,{data:re.value,stripe:"",border:"",style:{width:"100%"},fit:""},{default:y(()=>[f(K,{prop:"id",label:"需求ID",width:"80",align:"center"}),f(K,{prop:"requirement_name",label:"需求名称","min-width":"140",align:"center"},{default:y(e=>[Y(M(e.row.requirement_name),1)]),_:1}),f(K,{prop:"project_name",label:"所属项目","min-width":"120",align:"center"}),f(K,{prop:"iteration_name",label:"所属迭代","min-width":"120",align:"center"},{default:y(e=>[Y(M(e.row.iteration_name||"-"),1)]),_:1}),f(K,{prop:"status",label:"状态","min-width":"90",align:"center"},{default:y(e=>{return[f(le,{type:(a=e.row.status,{new:"info",in_progress:"warning",completed:"success",cancelled:"danger"}[a]||"info")},{default:y(()=>[Y(M(ie(e.row.status)),1)]),_:2},1032,["type"])];var a}),_:1}),f(K,{prop:"priority",label:"优先级","min-width":"80",align:"center"},{default:y(e=>{return[f(le,{type:(a=e.row.priority,{high:"danger",medium:"warning",low:"success"}[a]||"info")},{default:y(()=>[Y(M(ue(e.row.priority)),1)]),_:2},1032,["type"])];var a}),_:1}),f(K,{prop:"environment",label:"环境","min-width":"90",align:"center"},{default:y(e=>{return[f(le,{type:(a=e.row.environment,{test:"info",staging:"warning",production:"success"}[a]||"info")},{default:y(()=>[Y(M(de(e.row.environment)),1)]),_:2},1032,["type"])];var a}),_:1}),f(K,{prop:"created_by_name",label:"创建者","min-width":"100",align:"center"}),f(K,{prop:"assigned_to_name",label:"负责人","min-width":"100",align:"center"},{default:y(e=>[Y(M(e.row.assigned_to_name||"-"),1)]),_:1}),f(K,{prop:"start_time",label:"开始时间","min-width":"140",align:"center"},{default:y(e=>[Y(M(A(q)(e.row.start_time)||"-"),1)]),_:1}),f(K,{prop:"end_time",label:"结束时间","min-width":"140",align:"center"},{default:y(e=>[Y(M(A(q)(e.row.end_time)||"-"),1)]),_:1}),f(K,{prop:"requirement_description",label:"需求描述","min-width":"220",align:"center"},{default:y(e=>[p("div",L,M(e.row.requirement_description||"-"),1)]),_:1}),f(K,{label:"操作","min-width":"140",fixed:"right",align:"center"},{default:y(e=>[p("div",T,[f(g,{type:"success",size:"small",onClick:a=>{return l=e.row,void w.info(`编辑需求: ${l.requirement_name}`);var l}},{default:y(()=>[...d[8]||(d[8]=[Y("编辑",-1)])]),_:1},8,["onClick"]),f(g,{type:"danger",size:"small",onClick:a=>{return l=e.row,void C.confirm(`确定要删除需求「${l.requirement_name}」吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{w.success("需求删除成功"),ne()}catch(e){console.error("删除需求失败:",e),w.error("删除需求失败")}}).catch(()=>{});var l}},{default:y(()=>[...d[9]||(d[9]=[Y("删除",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),[[we,F.value]])]),p("div",H,[f(fe,{"current-page":"pagination.currentPage","page-size":"pagination.pageSize","page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:se.total,onSizeChange:ye,onCurrentChange:he},null,8,["total"])])])}}},[["__scopeId","data-v-42d683e0"]]);export{F as default};
